name: ü§ñ Trading Bot 24/7

on:
  push:
    branches: [ main ]
  schedule:
    # R√©veil toutes les 15 minutes
    - cron: '*/15 * * * *'
  workflow_dispatch:
    # Permet de lancer manuellement depuis l'interface GitHub

jobs:
  trade:
    runs-on: ubuntu-latest
    timeout-minutes: 10  # Prevent workflow hangs
    
    steps:
    - name: üì• Clone Repository
      uses: actions/checkout@v4

    - name: üêç Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'
        cache: 'pip'

    - name: üîÑ Cache TA-Lib
      uses: actions/cache@v4
      id: cache-talib
      with:
        path: ta-lib-install
        key: talib-${{ runner.os }}-0.4.0-v1

    - name: üõ†Ô∏è Install Dependencies
      env:
        TA_INCLUDE_PATH: ${{ github.workspace }}/ta-lib-install/include
        TA_LIBRARY_PATH: ${{ github.workspace }}/ta-lib-install/lib
      run: |
        python -m pip install --upgrade pip
        # Install TA-Lib from source only if not cached
        if [ "${{ steps.cache-talib.outputs.cache-hit }}" != 'true' ]; then
          wget http://prdownloads.sourceforge.net/ta-lib/ta-lib-0.4.0-src.tar.gz
          tar -xzf ta-lib-0.4.0-src.tar.gz
          cd ta-lib/
          ./configure --prefix=${{ github.workspace }}/ta-lib-install
          make
          make install
          cd ..
        fi
        pip install -r requirements.txt

    - name: üåê Ensure IPv4 Connectivity
      run: |
        # Disable IPv6 to force IPv4 (fixes Supabase connection issues)
        sudo sysctl -w net.ipv6.conf.all.disable_ipv6=1
        sudo sysctl -w net.ipv6.conf.default.disable_ipv6=1

    - name: üöÄ Run Trading Cycle
      env:
        # TA-Lib Runtime Linkage
        LD_LIBRARY_PATH: ${{ github.workspace }}/ta-lib-install/lib
        # Kraken API Keys (configured in GitHub Secrets)
        KRAKEN_API_KEY: ${{ secrets.KRAKEN_API_KEY }}
        KRAKEN_SECRET_KEY: ${{ secrets.KRAKEN_SECRET_KEY }}
        # Database (use Supabase Pooler URL for IPv4 compatibility)
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        # Trading configuration
        ACTIVE_EXCHANGE: kraken
        PAPER_TRADING: ${{ secrets.PAPER_TRADING || 'true' }}
        # Notifications (optional)
        TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        PYTHONPATH: .
      run: python scripts/gh_actions_trade.py

